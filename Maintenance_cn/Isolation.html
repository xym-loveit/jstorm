<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm 文档 : How to enable resource isolation?</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads.html">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance_cn">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/quickstart_cn/BasicConception.html">5分钟基础概念(新手第一篇)</a></li>
                
                <li class=""><a href="/quickstart_cn/Example.html">入门Example</a></li>
                
                <li class=""><a href="/quickstart_cn/Deploy/">安装部署</a></li>
                
                <li class=""><a href="/quickstart_cn/Upgrade/">升级</a></li>
                
                <li class=""><a href="/quickstart_cn/UpgradeFromStorm.html">从Apache Storm升级到JStorm</a></li>
                
                <li class=""><a href="/quickstart_cn/Compile.html">编译JStorm</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/ProgrammingGuide_cn/DebugLocalApp.html">本地调试</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/StreamSplitJoin.html">数据流分流合并</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Transaction/">事务</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Trident/">Trident</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/AdvancedUsage/">Advanced Usage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown active">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">运维 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance_cn/Configuration.html">配置注解</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ConfigurationAutomacticSync.html">自动同步配置文件</a></li>
                  
                  <li class="active"><a href="/Maintenance_cn/Isolation.html">资源隔离</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/HealthCheck.html">Supervisor自检</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/JStorm-on-Yarn.html">JStorm-on-Yarn</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ClusterHA.html">同城灾备&异地灾备</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/BlobStore.html">BlobStore</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/DynamicAdjustLog.html">动态调整日志</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ_cn/">FAQ</a></li>



            <!-- Community -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">社区 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Community/Email.html">Email List</a></li>
                  
                  <li class=""><a href="/Community/Committers.html">Committer List</a></li>
                  
                  <li class=""><a href="/Community/Events-Meetups.html">Events and Meetups</a></li>
                  
                  <li class=""><a href="/Community/Issues.html">Track issues</a></li>
                  
                  <li class=""><a href="/Community/JStormUsers.html">JStorm User List</a></li>
                  
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="/index.html">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>

              </ul>
            </li>
            <li class="hidden-sm "><a href="http://storm.taobao.org">Demo</a></li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">

  
  
  <div class="col-md-8 col-md-offset-2 text">
    <h1>How to enable resource isolation?</h1>
	<ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">概述</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">配置</a>    <ul>
      <li><a href="#cgroup" id="markdown-toc-cgroup">启动cgroup服务</a></li>
      <li><a href="#section-2" id="markdown-toc-section-2">或者直接执行命令</a></li>
      <li><a href="#jstormcgroup-stormyaml" id="markdown-toc-jstormcgroup-stormyaml">在jstorm配置文件中打开cgroup, 配置storm.yaml</a></li>
    </ul>
  </li>
</ul>

<h1 id="section">概述</h1>
<p>资源隔离是每个计算平台都需要具备的能力， 资源隔离分为几个层次：</p>

<ul>
  <li>集群之间</li>
  <li>
    <ul>
      <li>standalone, 直接对集群进行物理隔离部署， 资源隔离效果最理想，缺点是，资源容易浪费</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>jstorm-on-yarn, jstorm-on-docker,  通过yarn 或docker-swam ， 在一个物理集群上部署多个逻辑集群， 而逻辑集群之间进行资源隔离</li>
    </ul>
  </li>
  <li>集群内</li>
  <li>
    <ul>
      <li>自定义调度， 可以通过jstorm的自定义调度，强制一些任务运行在某些机器上，从而独占这些机器</li>
    </ul>
  </li>
  <li>
    <ul>
      <li>worker-cgroup,  对worker 进行cgroup设置， 进行cpu和内存进行资源隔离。</li>
    </ul>
  </li>
</ul>

<p>本文主要介绍， jstorm的 集群内部的 worker-cgroup 配置方式。</p>

<p>补充一下： 业界常用的2种cgroup 方式，不如jstorm的cgroup方式高效</p>

<ul>
  <li>绑核方式， 比如yarn上常用的一种方式，一个worker 绑定到一个cpu 核上， 这种方式最大的问题是， 当worker 忙时， 不能自动扩容到2核或3核， 因此常常任务不能完成； 当worker不忙时， cpu却又不能共享出来；而真实运行中，发现这种方式的集群，cpu利用率非常低下， 一台机器，只有极少的worker 能使用满绑定的核， 绝大部分worker 处在空闲状态。</li>
  <li>共享方式， 所有worker 申请一定的权重， 假设3个worker， worker a 权重100， 处于cpu 疯跑状态， worker b 权重 200， 处于疯跑， worker c 权重100 正常状态，最终结果就是 worker a 差不多用掉1/3 的cpu， worker b 差不多用掉 2/3 的cpu， worker c 基本用不了多少cpu， 但整个机器load会非常重, 不断报警.</li>
</ul>

<p>jstorm 使用的方式 是共享方式 ＋  上限方式， 就是worker 按照权重申请cpu，但同时设置一个worker的上限cpu阀值（默认4核）， 也就是在共享的基础上，每个worker 使用的cpu 上限不能超过4个核， 这样既能保障机器worker 忙时，可以自动用掉2核或3核， 闲的时候，cpu能空闲给其他worker使用，更为关键是， 不会让一个worker 疯跑，不会因为一个worker疯跑，导致整个机器load 非常高，其他的worker基本抢不到cpu。</p>

<p>我们这种方式，在实际使用中， 效果非常好。</p>

<p>补充一下：cgroups是control groups的缩写，是Linux内核提供的一种可以限制, 记录, 隔离进程组(process groups)所使用的物理资源(如：cpu,memory,IO 等等)的机制。</p>

<h1 id="section-1">配置</h1>

<p>在Jstorm中，我们使用cgroup进行cpu硬件资源的管理。使用前，需要做如下检查和配置。</p>

<ul>
  <li>检查/etc/passwd 文件中当前用户的uid和gid， 假设当前用户是admin， 则看/etc/passwd文件中admin的uid和gid是多少</li>
  <li>cgroup功能在当前系统的内核版本是否支持</li>
</ul>

<p>检查/etc/cgconfig.conf是否存在。如果不存在， 请“yum install libcgroup”，如果存在，设置cpu子系统的挂载目录位置，
以及修改该配置文件中相应的uid/gid为启动jstorm用户的uid/gid， 本例子中以500为例， 注意是根据第一步来进行设置的。</p>

<pre><code>  mount {    
      cpu = /cgroup/cpu;
  }
  

  group jstorm {
       perm {
               task {
                      uid = 500;
                      gid = 500;
               }
               admin {
                      uid = 500;
                      gid = 500;
               }
       }
       cpu {
       }
  }
</code></pre>

<p>这是一个cgconfig.conf配置文件例子。比如jstorm的启动用户为admin，admin在当前
  系统的uid/gid为500（查看/etc/passwd 可以查看到uid和gid），那么相对应cpu子系统的jstorm目录uid/gid也需要设置为相同的值。
  以便jstorm有相应权限可以在这个目录下为jstorm的每个需要进行资源隔离的进程创建对应
  的目录和进行相关设置。</p>

<h3 id="cgroup">启动cgroup服务</h3>

<pre><code>service cgconfig restart
chkconfig --level 23456 cgconfig on
</code></pre>

<p>Note: cgconfig.conf只能在root模式下修改。</p>

<h3 id="section-2">或者直接执行命令</h3>

<pre><code>mkdir /cgroup/cpu
mount  -t cgroup -o cpu none /cgroup/cpu
mkdir /cgroup/cpu/jstorm
chown admin:admin /cgroup/cpu/jstorm
</code></pre>

<h2 id="jstormcgroup-stormyaml">在jstorm配置文件中打开cgroup, 配置storm.yaml</h2>

<pre><code>   supervisor.enable.cgroup: true
</code></pre>


  <div class="footer">
      Google Groups: <a target="_blank" href="https://groups.google.com/forum/#!forum/jstorm-user">jstorm-user</a>, QQ Groups: 228374502
      </p>
 
      发现错误？想参与编辑？
      <a href="https://github.com/alibaba/jstorm/edit/master/docs/jstorm-doc/Maintenance_cn/Isolation.md" target="_blank">
        在 Github 上编辑此页！
      </a>
  </div>
  </div>
  

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
