<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm Documentation : Performance</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            
            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads.html">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm active"><a href="/Performance">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/quickstart/BasicConception.html">Basic Conception</a></li>
                
                <li class=""><a href="/quickstart/Example.html">Example</a></li>
                
                <li class=""><a href="/quickstart/Deploy/">Deploy</a></li>
                
                <li class=""><a href="/quickstart/Upgrade/">Upgrade</a></li>
                
                <li class=""><a href="/quickstart/UpgradeFromStorm.html">Migrate from Apache Storm</a></li>
                
                <li class=""><a href="/quickstart/Compile.html">Comple JStorm</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/ProgrammingGuide/DebugLocalApp.html">Local Debug</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/StreamSplitJoin.html">Split-Merge-Stream</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/Transaction.html">Transaction</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/Trident.html">Trident</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide/AdvancedUsage/">Advanced Usage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Maintenance <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance/Configuration.html">Configuration</a></li>
                  
                  <li class=""><a href="/Maintenance/ConfigurationAutomacticSync.html">Automatically Sync Configuration</a></li>
                  
                  <li class=""><a href="/Maintenance/Isolation.html">Resource Isolation</a></li>
                  
                  <li class=""><a href="/Maintenance/HealthCheck.html">Supervisor Health Check</a></li>
                  
                  <li class=""><a href="/Maintenance/JStorm-on-Yarn.html">JStorm-on-Yarn</a></li>
                  
                  <li class=""><a href="/Maintenance/ClusterHA.html">Cluster HA</a></li>
                  
                  <li class=""><a href="/Maintenance/DynamicAdjustLog.html">Dynamic Adjust Log</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ/">FAQ</a></li>

            <!-- Community -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Community <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Community/Email.html">Email List</a></li>
                  
                  <li class=""><a href="/Community/Committers.html">Committer List</a></li>
                  
                  <li class=""><a href="/Community/Events-Meetups.html">Events and Meetups</a></li>
                  
                  <li class=""><a href="/Community/Issues.html">Track issues</a></li>
                  
                  <li class=""><a href="/Community/JStormUsers.html">JStorm User List</a></li>
                  
              </ul>
            </li>


          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="/index.html">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>

              </ul>
            </li>
            <li class="hidden-sm "><a href="http://storm.taobao.org">Demo</a></li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">

  
  
  <div class="col-md-8 col-md-offset-2 text">
    <h1>Performance</h1>
	<ul id="markdown-toc">
  <li><a href="#section" id="markdown-toc-section">概述</a></li>
  <li><a href="#section-1" id="markdown-toc-section-1">性能背后原因</a></li>
  <li><a href="#section-2" id="markdown-toc-section-2">测试环境</a></li>
  <li><a href="#fastwordcount" id="markdown-toc-fastwordcount">使用FastWordCount</a>    <ul>
      <li><a href="#section-3" id="markdown-toc-section-3">测试用例说明</a></li>
      <li><a href="#section-4" id="markdown-toc-section-4">测试结果</a></li>
      <li><a href="#section-5" id="markdown-toc-section-5">测试插曲</a></li>
    </ul>
  </li>
  <li><a href="#wordcount" id="markdown-toc-wordcount">使用WordCount</a>    <ul>
      <li><a href="#section-6" id="markdown-toc-section-6">测试用例</a></li>
      <li><a href="#section-7" id="markdown-toc-section-7">测试结果</a></li>
    </ul>
  </li>
  <li><a href="#section-8" id="markdown-toc-section-8">真实用例 – 营销产品账</a>    <ul>
      <li><a href="#section-9" id="markdown-toc-section-9">测试用例</a></li>
      <li><a href="#section-10" id="markdown-toc-section-10">测试结果</a></li>
    </ul>
  </li>
</ul>

<h1 id="section">概述</h1>
<p>本次测试主要测试JStorm/Apache Storm/Apache Flink/Heron吞吐量, 业界主流的几种流式计算框架。
从测试结果结果看，JStorm 大概是Apache Storm 4倍， Apache Flink 1.5 倍， Twitter Heron 2 ~ 10 倍。</p>

<h1 id="section-1">性能背后原因</h1>

<ul>
  <li>Apache Storm, mini-batch 做的不够优秀， 导致效率并不高</li>
  <li>Apache Flink, mini-batch 做的非常优秀， 但资源利用率没有做上来， 因为单机所有的task都跑在一个进程内， 内存共享很充分，进程内通信也非常优秀，但单机下只在一个进程内部， 无法充分利用cpu 资源。也就是会遇到cpu 使用上限问题</li>
  <li>Twitter Heron, 存在致命设计缺陷
    <ul>
      <li>Heron 最大的噱头 “10 倍storm性能”， 但heron 对比的对象是storm 0.8.2,  这是3年前的storm，是上一代的storm， 而最新版storm 1.0.2 早已经是storm 0.8.2  的十倍性能。</li>
      <li>heron在性能上存在几个致命缺陷
        <ul>
          <li>失去了整个业界性能优化很大的一个方向， 流计算图优化。其核心思想就是让task尽量绑在一个进程中， 这样task之间的数据，可以直接走进程内通信，无需反序列化和序列化。</li>
          <li>为了提高稳定性， heron将每个task 独立成为一个进程， 则会产生一个新的问题，就是task之间的通信都不会有进程内通信， 所有task通信都是走网络， 都要经过序列化和反序列化， 引入了大量额外的计算.</li>
          <li>如果想要图优化， 则heron必须引入一层新的概念， 将多个task 链接到一个进程中， 但这个设计和heron的架构设计理念会冲突</li>
        </ul>
      </li>
      <li>每个container 的stream manager 会成为瓶颈， 一个container 内部的所有task 的数据（无论数据对外还是对内）通信都必须经过stream manager，  一个进程他的网络tps是有上限的， 而stream-manager的上限就是50w qps， 则表示一个container的内部通道和外部通道总和就是50w qps. 大家都必须抢这个资源。</li>
      <li>原来的一次网络通信， 现在会变成3次网络通信， task －》 当前container的streammanager －》 目标container的stream manager －》 目标task</li>
    </ul>
  </li>
</ul>

<h1 id="section-2">测试环境</h1>
<ul>
  <li>10 台a8, 32 核／128g</li>
  <li>os: redhat rhel 7.2</li>
  <li>jdk: jdk8</li>
  <li>hdfs: 2.6.3</li>
  <li>mesos: 0.25.0</li>
  <li>aurora: 0.12.0</li>
  <li>jstorm: 2.2.0</li>
  <li>heron: 0.14.0 并打上heron最新性能优化patch</li>
  <li>flink: 1.0.3</li>
  <li>storm: 1.0.2</li>
  <li>worker/container 内存设置4g</li>
</ul>

<h1 id="fastwordcount">使用FastWordCount</h1>

<h2 id="section-3">测试用例说明</h2>

<p>FastWordCount 测试用例 来自<a href="https://github.com/apache/storm/blob/master/examples/storm-starter/src/jvm/org/apache/storm/starter/FastWordCountTopology.java">Apache Storm 的 FastWordCount</a> 分为3个stage, Spout 生成句子， 然后将句子发送到Split bolt, 而Split bolt 将句子切分成words， 然后对word 进行fieldGrouping (group by word), 最后 Count bolt 统计没个word的出现次数， spout-&gt; split &gt; count， 在该测试用例中，使用流计算中最常用的shuffler和fieldgrouping 方式， 所以基本能反映一个流式计算引擎的极限性能。</p>

<p>测试源码在https://github.com/alibaba/jstorm/tree/master/jstorm-utility/performance-test</p>

<h2 id="section-4">测试结果</h2>
<p><img src="http://img1.tbcdn.cn/L1/461/1/b71f91209bf03ce76279c26e2200a1dea72c86ef" alt="screenshot" />
<img src="http://img2.tbcdn.cn/L1/461/1/fc14b7cd6a6c427e8ff0c0939dc7196932973728" alt="screenshot" /></p>

<h2 id="section-5">测试插曲</h2>
<ul>
  <li>第一次跑，heron性能极差， 10个container只有2w qps， 咨询twitter， 告知，大量触发反压，可以打个patch 调整反压策略</li>
  <li>第二次跑（打上patch后），10个container可以到10多万， 但其实和storm相比，也是差很多, 咨询twitter 人员， 告知一个container内部task太多，容易发生反压</li>
  <li>第三次跑（修改container内部task数）， 10个container 跑到20w qps， 但我们依旧不满意，咨询twitter， 他们告知 他们也就只能跑20w qps， 并且告诉 一个很大问题， container内部的stream－manager的瓶颈是50w qps， 也就是一个container所有内部通信和外部通信的总和上限就是50w。</li>
</ul>

<h1 id="wordcount">使用WordCount</h1>

<h2 id="section-6">测试用例</h2>

<p>WordCount 是twitter 号称是storm 10倍性能的<a href="https://github.com/twitter/heron/blob/master/heron/examples/src/java/com/twitter/heron/examples/WordCountTopology.java">官方测试用例</a>， 分为2个stage， spout -&gt; count， 使用shuffle模式，并按照twitter给出的并发配置进行测试。</p>

<h2 id="section-7">测试结果</h2>

<p><img src="http://img3.tbcdn.cn/L1/461/1/a3adc55b13763d3f3651be2eb12484b832319e24" alt="screenshot" />	
<img src="http://img3.tbcdn.cn/L1/461/1/73f9814ee8006537ae7bbd54f38edebf9ee03922" alt="screenshot" /></p>

<h1 id="section-8">真实用例 – 营销产品账</h1>

<h2 id="section-9">测试用例</h2>

<ul>
  <li>输入为TT，offset表/结果表为hbase，中间表为本机内存。</li>
  <li>计算规则：12个group by条件下求max/min/count/sum等四个指标，每行记录共拆成48个指标。</li>
  <li>Topology分5个环节，一为Source，读取TT的数据，并记录offset；二为Mapper，解析数据及线上配置的规则，进行指标的分解；三为Reducer，增量内存计算，计算单位时间内的数据；四为Merge，合并计算，读取中间表数据，进行合并；五为Storage，持久化，写入最终结果表。</li>
</ul>

<p><img src="/img/performance/test-logic.png" alt="test-logic" /></p>

<h2 id="section-10">测试结果</h2>
<p><img src="/img/performance/jstorm-heron.png" alt="jstorm-heron.png" /></p>


  <div class="footer">
      Google Groups: <a target="_blank" href="https://groups.google.com/forum/#!forum/jstorm-user">jstorm-user</a>, QQ Groups: 228374502
      </p>
      Caught a mistake or want to contribute to the documentation? 
      <a href="https://github.com/alibaba/jstorm/edit/master/docs/jstorm-doc/Performance/index.md" target="_blank">
        Edit this page on Github!
      </a>
  </div>
  

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
