<!DOCTYPE html>
<!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- The above 3 meta tags *must* come first in the head; any other head content must come *after* these tags -->
    <title>JStorm 文档 : 从JStorm 0.9.x迁移至2.x</title>
    <link rel="shortcut icon" href="/img/favicon.png" type="image/x-icon">
    <link rel="icon" href="/img/favicon.png" type="image/x-icon">

    <!-- Bootstrap -->
    <link href="//cdn.bootcss.com/bootstrap/3.3.4/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="/css/jstorm.css">
    <link rel="stylesheet" href="/css/syntax.css">
    <link rel="stylesheet" href="/css/codetabs.css">
    
    <!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
    <!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
    <!--[if lt IE 9]>
      <script src="https://oss.maxcdn.com/html5shiv/3.7.2/html5shiv.min.js"></script>
      <script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
    <![endif]-->
  </head>
  <body>
    
    <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<!--




-->
    <!-- Top navbar. -->
    <nav class="navbar navbar-default navbar-fixed-top">
      <div class="container">
        <!-- The logo. -->
        <div class="navbar-header">
          <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#bs-example-navbar-collapse-1">
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
            <span class="icon-bar"></span>
          </button>
          <div class="navbar-logo">
            <a href="/"><img alt="jstorm" src="/img/jstorm-logo.png"></a>
          </div>
        </div><!-- /.navbar-header -->

        <!-- The navigation links. -->
        <div class="collapse navbar-collapse" id="bs-example-navbar-collapse-1">
          <ul class="nav navbar-nav">
            <!-- Downloads -->
            <li class="hidden-sm "><a href="/Downloads.html">Downloads</a></li>

            <!-- Performance -->
            <li class="hidden-sm "><a href="/Performance_cn">Performance</a></li>

            <!-- QuickStart -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">QuickStart <span class="caret"></span></a>
              <ul class="dropdown-menu" role="menu">
                
                
                <li class=""><a href="/quickstart_cn/BasicConception.html">5分钟基础概念(新手第一篇)</a></li>
                
                <li class=""><a href="/quickstart_cn/Example.html">入门Example</a></li>
                
                <li class=""><a href="/quickstart_cn/Deploy/">安装部署</a></li>
                
                <li class=""><a href="/quickstart_cn/Upgrade/">升级</a></li>
                
                <li class=""><a href="/quickstart_cn/UpgradeFromStorm.html">从Apache Storm升级到JStorm</a></li>
                
                <li class=""><a href="/quickstart_cn/Compile.html">编译JStorm</a></li>
                
              </ul>
            </li>

            <!-- ProgrammingGuide -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">ProgrammingGuide <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/ProgrammingGuide_cn/DebugLocalApp.html">本地调试</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/StreamSplitJoin.html">数据流分流合并</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Transaction/">事务</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/Trident/">Trident</a></li>
                  
                  <li class=""><a href="/ProgrammingGuide_cn/AdvancedUsage/">Advanced Usage</a></li>
                  
              </ul>
            </li>

            <!-- Maintenance -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">运维 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Maintenance_cn/Configuration.html">配置注解</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ConfigurationAutomacticSync.html">自动同步配置文件</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/Isolation.html">资源隔离</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/HealthCheck.html">Supervisor自检</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/JStorm-on-Yarn.html">JStorm-on-Yarn</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/ClusterHA.html">同城灾备&异地灾备</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/BlobStore.html">BlobStore</a></li>
                  
                  <li class=""><a href="/Maintenance_cn/DynamicAdjustLog.html">动态调整日志</a></li>
                  
              </ul>
            </li>

            <!-- FAQ -->
            <li class="hidden-sm "><a href="/FAQ_cn/">FAQ</a></li>



            <!-- Community -->
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">社区 <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  
                  
                  <li class=""><a href="/Community/Email.html">Email List</a></li>
                  
                  <li class=""><a href="/Community/Committers.html">Committer List</a></li>
                  
                  <li class=""><a href="/Community/Events-Meetups.html">Events and Meetups</a></li>
                  
                  <li class=""><a href="/Community/Issues.html">Track issues</a></li>
                  
                  <li class=""><a href="/Community/JStormUsers.html">JStorm User List</a></li>
                  
              </ul>
            </li>

          </ul>
          <ul class="nav navbar-nav navbar-right">
            <li class="dropdown">
              <a href="" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">Language <span class="caret"></span></a>
                <ul class="dropdown-menu" role="menu">
                  <li class=""><a href="/index.html">English</a></li>
                  <li class=""><a href="/index_cn.html">中文</a></li>

              </ul>
            </li>
            <li class="hidden-sm "><a href="http://storm.taobao.org">Demo</a></li>
          </ul>          
        </div><!-- /.navbar-collapse -->
      </div><!-- /.container -->
    </nav>


    

    <!-- Main content. -->
    <div class="container">
      
      <!--
Licensed to the Apache Software Foundation (ASF) under one
or more contributor license agreements.  See the NOTICE file
distributed with this work for additional information
regarding copyright ownership.  The ASF licenses this file
to you under the Apache License, Version 2.0 (the
"License"); you may not use this file except in compliance
with the License.  You may obtain a copy of the License at

  http://www.apache.org/licenses/LICENSE-2.0

Unless required by applicable law or agreed to in writing,
software distributed under the License is distributed on an
"AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
KIND, either express or implied.  See the License for the
specific language governing permissions and limitations
under the License.
-->
<div class="row">


  <!-- Sub Navigation -->
  <div class="col-sm-3">
    <ul id="sub-nav">
      
      
      
        
        <li><a href="/backup/quickstart_cn/description_scenarios_cn.html" class="">概叙 & 应用场景</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart_cn/conception_cn.html" class="">基本概念</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart_cn/install_cn.html" class="">如何安装</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart_cn/configuration_cn.html" class="">JStorm 配置</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart_cn/difference_cn.html" class="">和Storm的区别</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart_cn/migrate_cn.html" class="active">从JStorm 0.9.x迁移至2.x</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart_cn/upgrade_cn.html" class="">升级指南</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart_cn/user_define_log_cn.html" class="">自定义日志</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart_cn/web_ui_cn.html" class="">单Web UI 管理多集群</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart_cn/application_example_cn.html" class="">应用例子</a>
          
        </li>
      
        
        <li><a href="/backup/quickstart_cn/resource_isolate_cn.html" class="">资源硬隔离</a>
          
        </li>
      
    </ul>
  </div>
  <!-- Main -->
  <div class="col-sm-9">
    <!-- Top anchor -->
    <a href="#top"></a>

    <div class="text">
      <!-- Main heading -->
      <h1>从JStorm 0.9.x迁移至2.x</h1>

      <!-- Content -->
      <p>JStorm 2.x系列是一个全新的版本，它拥有0.9.x的所有feature，同时相比0.9.x系列，还有以下独有的feature：</p>

<hr />

<ol>
  <li>
    <p>更好的性能：jstorm 2.1.1对jstorm内核以及metrics进行了大符的性能优化，在我们的性能测试中，2.1.1在最差情况下，性能比0.9.8要好5%~10%。</p>
  </li>
  <li>
    <p>metrics底层完全重构，从新的web ui（koala）中我们可以监控所有metrics的历史曲线数据，而不像0.9.x系列版本，只有单点数据。同时非常方便地支持用户自定义metrics，使用基本上跟0.9.x一样的自定义metrics代码，即可在koala上面看到完整的metrics曲线。</p>
  </li>
  <li>
    <p>支持日志搜索：同时支持topology级别的日志搜索（会搜索一个topology下所有worker的日志）和单文件级别的日志搜索。</p>
  </li>
  <li>
    <p>jstorm 2.1.1支持jdk 1.8。</p>
  </li>
</ol>

<hr />

<p>但是JStorm 2.1.1并不完全向后兼容（主要是thrift版本和metrics接口），从JStorm 0.9.x迁移到JStorm 2.1.1需要做以下改动：</p>

<h3 id="section">1.集群重新安装</h3>

<p>见：<a href="https://github.com/alibaba/jstorm/wiki/JStorm_upgrade_guide">https://github.com/alibaba/jstorm/wiki/JStorm_upgrade_guide</a></p>

<h3 id="section-1">2.代码修改：</h3>

<p>a. 所有依赖，原来的jstorm依赖全部删除，包括jstorm-client, jstorm-server, jstorm-client-extension。</p>

<p>b. 添加jstorm-core依赖：</p>

<pre><code class="language-xml">&lt;dependency&gt;
    &lt;groupId&gt;com.alibaba.jstorm&lt;/groupId&gt;
    &lt;artifactId&gt;jstorm-core&lt;/artifactId&gt;
    &lt;version&gt;2.1.1&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>c. 重新编译。这一步可能会出错，因为如果你用了自定义metrics，很可能在2.1.1中，package名或者接口名都已经发生了变化，你需要把原来的package依赖删了，重新import一下。</p>

<h3 id="section-2">3. 关于日志框架【重要】</h3>
<p>和0.9.x系列使用log4j不同，jstorm 2.1.1默认使用了logback作为日志框架。</p>

<h4 id="logback">使用logback日志框架</h4>
<p>logback在一般使用时是兼容log4j的，也就是说log4j可以直接桥接到logback，具体为：</p>

<p>a. 添加slf4j-api, log4j-over-slf4j和logback依赖（其实加了logback依赖之后就不需要加slf4j-api依赖了），具体：</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;slf4j-api&lt;/artifactId&gt;
    &lt;version&gt;1.7.5&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;log4j-over-slf4j&lt;/artifactId&gt;
    &lt;version&gt;1.7.10&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
    &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
    &lt;version&gt;1.0.13&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>b. 排除pom中所有的slf4j-log4j12的依赖，因为slf4j-log4j12跟log4j-over-slf4j是冲突的：</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
    &lt;version&gt;1.7.5&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
</code></pre>

<p>这里版本一般是1.7.5，但是还要具体看你的应用pom仲裁出的版本。</p>

<p>理论上，这样就能够把log4j桥接到slf4j。</p>

<h4 id="log4j">使用log4j日志框架</h4>

<p>但是，<strong>如果应用代码中动态修改log4j的Pattern，Appender的方式，就会有问题</strong>。</p>

<p>这种情况下，没有什么选择，只能回退到log4j。具体做法跟桥接到logback有点相反：</p>

<p>a. 删除所有log4j-over-slf4j有依赖（如果有），删除logback的依赖，然后加入slf4j-log4j12的依赖和log4j的依赖。</p>

<pre><code>&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;log4j-over-slf4j&lt;/artifactId&gt;
    &lt;version&gt;1.7.10&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;ch.qos.logback&lt;/groupId&gt;
    &lt;artifactId&gt;logback-classic&lt;/artifactId&gt;
    &lt;version&gt;1.0.13&lt;/version&gt;
    &lt;scope&gt;provided&lt;/scope&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;org.slf4j&lt;/groupId&gt;
    &lt;artifactId&gt;slf4j-log4j12&lt;/artifactId&gt;
    &lt;version&gt;1.7.5&lt;/version&gt;
&lt;/dependency&gt;
&lt;dependency&gt;
    &lt;groupId&gt;log4j&lt;/groupId&gt;
    &lt;artifactId&gt;log4j&lt;/artifactId&gt;
    &lt;version&gt;1.2.17&lt;/version&gt;
&lt;/dependency&gt;
</code></pre>

<p>b. 除了pom的修改，还需要在代码中，在build topology时添加一行：</p>

<pre><code>ConfigExtension.setUserDefinedLog4jConf(conf, "jstorm.log4j.properties");
</code></pre>

<p>这行代码告诉jstorm使用log4j，并且把jstorm自带的jstorm.log4j.properties作为log4j的配置（当然用户也可以使用其他的log4j配置，此时需要将自定义的log4j配置放在你的jar包的classpath下，并且注意不要用”jstorm.log4j.properties”这种跟jstorm框架自带的配置重名的文件名）。</p>

<p>或者也可以使用配置的方式，在你的配置文件中增加一行：</p>

<pre><code>user.defined.log4j.conf: jstorm.log4j.properties
</code></pre>

<p>效果是一样的（注意如果是配置的话，需要保证你自己的应用会解析这个值，并且将它put到提交时的conf Map中）。</p>

<p>另外，如果你想设置你的集群默认对所有topology都使用log4j，而不是logback，那么你可以在storm.yaml中添加上面这行配置，然后把这个storm.yaml复制到所有supervisor中。</p>

<p>当然这样的代价是，如果你需要使用logback，则需要手动在你的应用中添加一行配置：</p>

<pre><code>user.defined.log4j.conf: 
</code></pre>

<p>把log4j的配置重置掉。这样它就会使用logback了。</p>

<h3 id="metrics">4.自定义metrics使用指南</h3>
<p>使用MetricClient来注册自定义metrics。目前支持以下几种metrics，请按需使用：</p>

<ul>
  <li>
    <p>COUNTER：计数器，如jstorm中的emitted, acked, failed都使用counter。</p>
  </li>
  <li>
    <p>METER：一般用于qps/tps的统计。jstorm中的sendTps, recvTps使用meter。</p>
  </li>
  <li>
    <p>GAUGE：一般用于统计一个瞬时值，如memUsed, cpuRatio，queueSize等这种瞬间的值。<strong>但是需要注意，gauge是不可聚合的</strong>，即如果你注册了一个task级别的gauge，你只能到koala web ui的task页面查看它的metrics，它并不会聚合到component级别，因为这种聚合没有实际意义（想象一下多个task的queueSize加一起是什么意思…）。</p>
  </li>
  <li>
    <p>HISTOGRAM：一般用于统计操作的耗时，如EmitTime，nextTupleTime等。</p>
  </li>
</ul>

<p>参考代码见example中sequence-split-merge工程TotalCount类。</p>
      
    </div>
  </div>

  
</div>

    </div><!-- /.container -->

    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="//cdn.bootcss.com/jquery/1.11.2/jquery.min.js"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="//cdn.bootcss.com/bootstrap/3.3.4/js/bootstrap.min.js"></script>
    <script src="//cdn.bootcss.com/anchor-js/3.1.0/anchor.min.js"></script>
    <script src="/js/jstorm.js"></script>

    <!-- Google Analytics -->
    <!-- script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-52545728-1', 'auto');
      ga('send', 'pageview');
    </script -->

    <!-- Baidu Analytics -->
    <script>
      var _hmt = _hmt || [];
      (function() {
        var hm = document.createElement("script");
        hm.src = "//hm.baidu.com/hm.js?835985ad7943d8c24bc3c1f155b7d4a2";
        var s = document.getElementsByTagName("script")[0]; 
        s.parentNode.insertBefore(hm, s);
      })();
    </script>


    <!-- Disqus -->
    
  </body>
</html>
